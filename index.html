<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x402rocks Token - Mint Now!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; }
        .header h1 { font-size: 48px; margin-bottom: 10px; }
        .header p { font-size: 20px; opacity: 0.95; }
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        .alert.show { display: block; }
        .alert.success { background: #d1fae5; color: #065f46; }
        .alert.error { background: #fee2e2; color: #991b1b; }
        .alert.info { background: #dbeafe; color: #1e40af; }
        .wallet-address {
            font-family: monospace;
            word-break: break-all;
            color: #667eea;
        }
        .stat-box {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
        }
        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš€ x402rocks Token</h1>
            <p>Mint 50,000 tokens for $1 USDC on Base Mainnet</p>
        </div>

        <div id="alert" class="alert"></div>
        <div id="loadingStatus" class="card" style="text-align: center;">
            <div class="loading-indicator"></div>
            <p style="margin-top: 10px;">Loading...</p>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="card">
                <div id="walletDisconnected">
                    <h2>Connect Your Wallet</h2>
                    <p style="margin: 15px 0;">Connect MetaMask to start minting</p>
                    <button id="connectBtn" class="btn">Connect Wallet</button>
                </div>
                
                <div id="walletConnected" style="display: none;">
                    <h2>âœ… Wallet Connected</h2>
                    <p class="wallet-address" id="walletAddress"></p>
                    <p>Balance: <span id="tokenBalance">0</span> x402rocks</p>
                    <button id="disconnectBtn" class="btn" style="background: #6b7280; margin-top: 10px;">Disconnect</button>
                </div>
            </div>

            <div class="card">
                <h2>ðŸ“Š Stats</h2>
                <div class="stat-box">
                    <div>Total Mints: <strong id="totalMints">-</strong></div>
                    <div>Remaining: <strong id="remainingMints">-</strong></div>
                    <div>Revenue: <strong id="totalRevenue">$0</strong></div>
                </div>
            </div>

            <div class="card" id="mintingSection" style="display: none;">
                <h2>ðŸŽ¯ Mint Tokens</h2>
                <p style="margin: 15px 0;">Price: <strong>$1 USDC</strong> = <strong>50,000 tokens</strong></p>
                <button id="mintBtn" class="btn" style="width: 100%;">Mint Tokens</button>
            </div>
        </div>
    </div>

    <!-- Try multiple CDN sources for better reliability -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" 
            onerror="loadBackupEthers()"></script>
    
    <script>
        // Backup CDN loader
        function loadBackupEthers() {
            console.log('Primary CDN failed, trying backup...');
            const script = document.createElement('script');
            script.src = 'https://cdn.ethers.io/lib/ethers-5.7.umd.min.js';
            script.onerror = function() {
                showAlert('Failed to load Web3 library. Please refresh the page.', 'error');
                document.getElementById('loadingStatus').style.display = 'none';
            };
            script.onload = function() {
                console.log('Backup CDN loaded successfully');
                initializeDApp();
            };
            document.head.appendChild(script);
        }

        // Wait for page and ethers.js to load
        let initAttempts = 0;
        const maxAttempts = 10;

        function tryInitialize() {
            if (typeof ethers !== 'undefined') {
                console.log('âœ… Ethers.js loaded successfully');
                initializeDApp();
            } else if (initAttempts < maxAttempts) {
                initAttempts++;
                console.log(`Waiting for ethers.js... (attempt ${initAttempts})`);
                setTimeout(tryInitialize, 500);
            } else {
                console.error('âŒ Failed to load ethers.js after multiple attempts');
                showAlert('Failed to load Web3 library. Please refresh the page.', 'error');
                document.getElementById('loadingStatus').style.display = 'none';
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryInitialize);
        } else {
            tryInitialize();
        }

        function initializeDApp() {
            document.getElementById('loadingStatus').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            setupEventListeners();
            updateStats();
            setInterval(updateStats, 15000);
        }

        // âš ï¸ UPDATE THIS WITH YOUR CONTRACT ADDRESS!
        const CONTRACT_ADDRESS = "0x90AcD7128e5cdb7A4211Db0BE059400e35B329C3";
        const USDC_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
        
        const ABI = [
            "function mint(address to) external",
            "function balanceOf(address) view returns (uint256)",
            "function getGlobalStats() view returns (uint256,uint256,uint256,uint256)"
        ];
        
        const USDC_ABI = [
            "function approve(address,uint256) returns (bool)",
            "function allowance(address,address) view returns (uint256)"
        ];

        let provider, signer, contract, usdcContract, userAddress;

        function showAlert(msg, type) {
            const alert = document.getElementById('alert');
            alert.textContent = msg;
            alert.className = `alert ${type} show`;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        async function connectWallet() {
            console.log('ðŸ”— Connecting wallet...');
            
            if (typeof ethers === 'undefined') {
                showAlert('Web3 library not loaded. Please refresh the page.', 'error');
                return;
            }

            if (!window.ethereum) {
                showAlert('MetaMask not detected! Please install MetaMask.', 'error');
                setTimeout(() => {
                    window.open('https://metamask.io/download/', '_blank');
                }, 2000);
                return;
            }

            try {
                showAlert('Opening MetaMask...', 'info');
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                console.log('âœ… MetaMask connected:', accounts[0]);
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                const network = await provider.getNetwork();
                console.log('ðŸŒ Network:', network.chainId);
                
                if (network.chainId !== 8453) {
                    showAlert('Switching to Base Mainnet...', 'info');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }]
                        });
                        // Wait a moment for network switch
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x2105',
                                    chainName: 'Base Mainnet',
                                    nativeCurrency: { name: 'Ethereum', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            provider = new ethers.providers.Web3Provider(window.ethereum);
                        } else {
                            throw switchError;
                        }
                    }
                }
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                console.log('ðŸ‘¤ User address:', userAddress);
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);
                
                document.getElementById('walletDisconnected').style.display = 'none';
                document.getElementById('walletConnected').style.display = 'block';
                document.getElementById('mintingSection').style.display = 'block';
                document.getElementById('walletAddress').textContent = 
                    userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                
                await updateBalance();
                showAlert('âœ… Wallet connected successfully!', 'success');
                
            } catch (e) {
                console.error('âŒ Connection error:', e);
                showAlert('Connection failed: ' + e.message, 'error');
            }
        }

        async function updateBalance() {
            if (!contract || !userAddress) return;
            try {
                const bal = await contract.balanceOf(userAddress);
                document.getElementById('tokenBalance').textContent = 
                    parseFloat(ethers.utils.formatEther(bal)).toLocaleString();
            } catch(e) {
                console.error('Balance error:', e);
            }
        }

        async function updateStats() {
            try {
                const p = new ethers.providers.JsonRpcProvider('https://mainnet.base.org');
                const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, p);
                const [total, remaining, , revenue] = await c.getGlobalStats();
                document.getElementById('totalMints').textContent = total.toString();
                document.getElementById('remainingMints').textContent = remaining.toString();
                document.getElementById('totalRevenue').textContent = 
                    '$' + parseFloat(ethers.utils.formatUnits(revenue, 6)).toLocaleString();
            } catch(e) {
                console.log('Stats not available yet (contract not deployed)');
                document.getElementById('totalMints').textContent = '0';
                document.getElementById('remainingMints').textContent = '40,000';
                document.getElementById('totalRevenue').textContent = '$0';
            }
        }

        async function mint() {
            if (!userAddress) {
                showAlert('Please connect wallet first!', 'error');
                return;
            }

            try {
                document.getElementById('mintBtn').disabled = true;
                showAlert('Checking USDC allowance...', 'info');
                
                const allowance = await usdcContract.allowance(userAddress, CONTRACT_ADDRESS);
                const needed = ethers.utils.parseUnits('1', 6);
                
                if (allowance.lt(needed)) {
                    showAlert('Please approve USDC in MetaMask...', 'info');
                    const approveTx = await usdcContract.approve(
                        CONTRACT_ADDRESS, 
                        ethers.constants.MaxUint256
                    );
                    showAlert('Waiting for approval confirmation...', 'info');
                    await approveTx.wait();
                    showAlert('USDC approved! Now minting...', 'info');
                }
                
                showAlert('Please confirm mint transaction in MetaMask...', 'info');
                const mintTx = await contract.mint(userAddress);
                
                showAlert('Transaction sent! Waiting for confirmation...', 'info');
                await mintTx.wait();
                
                showAlert('ðŸŽ‰ Successfully minted 50,000 tokens!', 'success');
                
                await updateBalance();
                await updateStats();
                
            } catch(e) {
                console.error('âŒ Mint error:', e);
                let errorMsg = e.message;
                if (e.message.includes('insufficient funds')) {
                    errorMsg = 'Insufficient ETH for gas fees';
                } else if (e.message.includes('user rejected')) {
                    errorMsg = 'Transaction rejected';
                }
                showAlert('Minting failed: ' + errorMsg, 'error');
            } finally {
                document.getElementById('mintBtn').disabled = false;
            }
        }

        function setupEventListeners() {
            document.getElementById('connectBtn').onclick = connectWallet;
            document.getElementById('disconnectBtn').onclick = () => location.reload();
            document.getElementById('mintBtn').onclick = mint;
            
            // Listen for account changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        location.reload();
                    } else {
                        connectWallet();
                    }
                });
                
                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });
            }
        }
    </script>
</body>
</html>
